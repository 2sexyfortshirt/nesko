<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>NESKO COVERS ‚Äî Artist Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1: #09030a;
  --bg-2: #120021;
  --accent-1: #c400ff;
  --accent-2: #00ffe7;
  --glass: rgba(255,255,255,0.06);
  --muted: rgba(255,255,255,0.65);
}
*{box-sizing:border-box}
html,body{height:100%}
body {
  margin:0;padding:32px 28px 80px;
  font-family: 'Poppins', sans-serif;
  background: radial-gradient(1200px 600px at 10% 10%, rgba(196,0,255,0.08), transparent),
              radial-gradient(800px 400px at 90% 80%, rgba(0,230,231,0.04), transparent),
              linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
  color:#f4f4f6;
  -webkit-font-smoothing:antialiased;
}
.body-lights{
  position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:0;overflow:hidden;
}
.light-ray{position:absolute;width:40vw;height:80vh;left:-10%;top:-10%;transform:rotate(-20deg);filter:blur(80px);opacity:0.06;background:linear-gradient(90deg, rgba(196,0,255,0.9), rgba(0,230,231,0.7));animation:drift 12s linear infinite;}
.light-ray.r2{left:40%;top:-30%;transform:rotate(10deg);animation-duration:18s;opacity:0.045}
.light-ray.r3{left:70%;top:10%;transform:rotate(-35deg);animation-duration:24s;opacity:0.035}
@keyframes drift{0%{transform:translateX(-8%) rotate(-20deg)}50%{transform:translateX(8%) rotate(-20deg)}100%{transform:translateX(-8%) rotate(-20deg)}}

header{position:relative;z-index:2;max-width:1280px;margin:0 auto}
h1{font-family:'Playfair Display', serif;font-size:52px;margin:8px 0 6px;color:#fff;letter-spacing:0.6px;text-align:center;text-shadow:0 6px 30px rgba(0,0,0,0.8)}
.subtitle{color:var(--muted);text-align:center;margin-bottom:22px}

.search-wrap{display:flex;justify-content:center;margin-bottom:28px}
.search{display:flex;gap:12px;width:100%;max-width:760px}
.search input[type="text"]{flex:1;padding:14px 18px;border-radius:16px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff;font-size:16px;backdrop-filter:blur(6px)}
.search input[type="text"]:focus{outline:none;box-shadow:0 0 20px rgba(196,0,255,0.12);border-color:rgba(196,0,255,0.25)}
.search button{background:linear-gradient(135deg,var(--accent-1),#7a00ff);border:none;padding:12px 18px;border-radius:14px;color:#fff;font-weight:700;cursor:pointer}

.container{position:relative;z-index:2;max-width:1280px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr;gap:28px;align-items:start}
@media(max-width:960px){.container{grid-template-columns:1fr;padding:0 12px}}

.audio-list{display:flex;flex-direction:column;gap:18px}
.card{display:flex;gap:16px;align-items:center;padding:18px;border-radius:16px;background:var(--glass);border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(8px);transition:transform .28s,box-shadow .28s}
.card:hover{transform:translateY(-6px);box-shadow:0 12px 40px rgba(0,0,0,0.6);border-color:rgba(196,0,255,0.16)}

.cover-thumb{flex:0 0 92px;height:92px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(0,0,0,0.2));overflow:hidden;display:flex;align-items:center;justify-content:center}
.cover-thumb img{width:100%;height:100%;object-fit:cover}

.card-meta{flex:1;min-width:0}
.artist{font-family:'Playfair Display', serif;font-size:18px;font-weight:600;color:#fff}
.filename{display:block;color:#d9c7ff;margin-top:4px;font-size:14px}
.genre{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);color:#bff7ee;font-size:13px}

.card-controls{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
.buttons{display:flex;gap:8px}
.buy-btn{background:linear-gradient(135deg,var(--accent-2),#0088ff);border:none;padding:10px 14px;border-radius:12px;color:#021019;font-weight:800;cursor:pointer}
.play-btn{background:linear-gradient(135deg,var(--accent-1),#7a00ff);border:none;padding:10px 14px;border-radius:12px;color:#fff;font-weight:800;cursor:pointer}

.progress-container{display:flex;align-items:center;gap:10px;width:100%;margin-top:10px}
.current-time,.duration{font-size:13px;color:rgba(255,255,255,0.75);min-width:42px;text-align:center}
.progress-bar{flex:1;height:6px;border-radius:6px;background:transparent}
.progress-bar::-webkit-slider-runnable-track{height:6px;border-radius:6px;background:linear-gradient(90deg,#5b00ff,#00ffe7)}
.progress-bar::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;margin-top:-4px;box-shadow:0 2px 8px rgba(0,0,0,0.6)}

.player-expanded{position:fixed;left:50%;transform:translateX(-50%);bottom:26px;z-index:9999;background:linear-gradient(180deg,rgba(18,0,30,0.96),rgba(6,0,12,0.92));padding:14px 18px;border-radius:18px;display:flex;gap:14px;align-items:center;box-shadow:0 12px 60px rgba(0,0,0,0.7);border:1px solid rgba(196,0,255,0.12);min-width:340px}
.player-expanded .thumb{width:72px;height:72px;border-radius:10px;overflow:hidden}
.player-expanded .meta{min-width:0}
.player-expanded .artist{font-size:16px}
.player-expanded .controls{display:flex;gap:10px;align-items:center}
.player-expanded.hidden{display:none}
.player-expanded {
  pointer-events: none;
}
.player-expanded * {
  pointer-events: auto; /* —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
}

.right-column{display:flex;flex-direction:column;gap:16px}
.section-title{font-size:18px;font-weight:700;color:#fff;margin-bottom:6px}
.video-card{border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
.video-card video{width:100%;height:auto;display:block}

.modal{position:fixed;left:0;top:0;right:0;bottom:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.6);z-index:2000}
.modal .modal-panel{background:linear-gradient(180deg,#190021,#120014);padding:22px;border-radius:14px;color:#fff;min-width:300px;text-align:center;border:1px solid rgba(196,0,255,0.12)}
.modal .modal-panel a.download{display:inline-block;margin-top:12px;padding:10px 16px;background:linear-gradient(135deg,#00ffe7,#00a0ff);color:#001018;border-radius:10px;font-weight:700}

.waves{position:absolute;left:0;right:0;bottom:0;height:200px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.25));pointer-events:none}
.wave-svg{position:absolute;left:0;bottom:-20px;width:100%;opacity:0.06}

@media(max-width:560px){
  h1{font-size:32px}
  .card{padding:16px;flex-direction:column;align-items:center;text-align:center}
  .cover-thumb{flex:0 0 120px;height:120px;margin-bottom:12px}
  .player-expanded{left:12px;right:12px;transform:none;bottom:12px;width:auto}
  .play-btn,.buy-btn{padding:14px 18px;border-radius:50%;font-size:16px;width:60px;height:60px}
  .card-controls{flex-direction:row;justify-content:center;width:100%}
}
</style>
</head>
<body>
<div class="body-lights" aria-hidden="true">
  <div class="light-ray"></div>
  <div class="light-ray r2"></div>
  <div class="light-ray r3"></div>
</div>
<header>
  <h1>NESKO COVERS</h1>
  <div class="subtitle"></div>
  <div class="search-wrap">
    <form class="search" method="get" action="/">
      <input type="text" id="search" name="q" value="{{ query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏—Å—Ç—É –∏–ª–∏ –∂–∞–Ω—Ä—É...">
      <button type="submit">üîç</button>
    </form>
  </div>
</header>
<main class="container">
  <section class="left" aria-label="–ú—É–∑—ã–∫–∞">
    <div class="audio-list">
      {% if covers %}
        <div class="section-title">üéµ –ú—É–∑—ã–∫–∞</div>
        {% for cover in covers %}
        <article class="card" data-filename="{{ cover.filename }}">
          <div class="cover-thumb">
            {% if cover.thumb_url %}
              <img src="{{ cover.thumb_url }}" alt="{{ cover.filename }}">
            {% else %}
              <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;color:rgba(255,255,255,0.92);font-size:22px;background:linear-gradient(180deg,rgba(196,0,255,0.12),rgba(0,230,231,0.06));">{{ cover.artist[0]|upper }}</div>
            {% endif %}
          </div>
          <div class="card-meta">
            <div class="artist">{{ cover.artist }}</div>
            <div class="filename">{{ cover.filename }}</div>
            <div class="genre">{{ cover.genre }}</div>
            <div class="progress-container" aria-hidden="true">
              <span class="current-time">0:00</span>
              <input type="range" class="progress-bar" value="0" min="0" max="30" step="0.1">
              <span class="duration">0:00</span>
            </div>
            <audio src="{{ cover.url }}" preload="metadata" class="audio-player"></audio>
          </div>
          <div class="card-controls">
            <div class="buttons">
              <button class="buy-btn" data-filename="{{ cover.filename }}">üí≥ ${{ (cover.price / 100)|round(2) }}</button>
              <button class="play-btn">‚ñ∂</button>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.</p>
      {% endif %}
    </div>
  </section>
  <aside class="right-column" aria-label="–í–∏–¥–µ–æ">
    {% if videos %}
      <div class="section-title">üé¨ –í–∏–¥–µ–æ</div>
      {% for video in videos %}
      <div class="video-card">
        <video src="{{ video.url }}" controls playsinline preload="metadata"></video>
      </div>
      {% endfor %}
    {% endif %}
  </aside>
</main>

<!-- expanded player -->
<div id="player-expanded" class="player-expanded hidden" role="region" aria-label="Mini player">
  <div class="thumb"><img id="player-thumb" src="" alt="" style="width:100%;height:100%;object-fit:cover"></div>
  <div class="meta">
    <div id="player-artist" class="artist">Artist</div>
    <div id="player-title" class="filename">Title</div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <div class="controls">
        <button id="player-play" class="play-btn" style="padding:8px 12px;font-size:14px">‚ñ∂</button>
      </div>
      <div style="font-size:13px;color:rgba(255,255,255,0.8)" id="player-time">0:00 / 0:30</div>
    </div>
  </div>
</div>

<!-- modal -->
<div id="buy-modal" class="modal" role="dialog" aria-modal="true">
  <div class="modal-panel">
    <div id="modal-message">‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–º–∏—Ç–∏—Ä–æ–≤–∞–Ω–∞!</div>
    <a id="download-link" class="download" href="#">–°–∫–∞—á–∞—Ç—å</a>
    <div style="margin-top:14px"><button onclick="closeModal()" style="padding:8px 12px;border-radius:8px;border:none;background:#fff;color:#111;font-weight:700">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
</div>

<div class="waves" aria-hidden="true">
  <svg class="wave-svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,40 C150,120 350,0 600,40 C850,80 1050,30 1200,60 L1200,120 L0,120 Z" fill="#ffffff"/></svg>
</div>

<script>
// ======= HELPERS =======
const formatTime = t => {
  t = Math.floor(t);
  const m = Math.floor(t/60);
  const s = t % 60;
  return `${m}:${s<10? '0'+s : s}`;
};

// ======= ELEMENTS =======
const cards = Array.from(document.querySelectorAll('.card'));
const modal = document.getElementById('buy-modal');
const downloadLink = document.getElementById('download-link');

const player = document.getElementById('player-expanded');
const playerThumb = document.getElementById('player-thumb');
const playerArtist = document.getElementById('player-artist');
const playerTitle = document.getElementById('player-title');
const playerPlay = document.getElementById('player-play');
const playerTime = document.getElementById('player-time');

let expandedAudio = null;
let fragmentTimeout = null;

// ======= MODAL =======
function closeModal(){ modal.style.display = 'none'; }

// ======= AUDIO CARDS =======
cards.forEach(card => {
  const audio = card.querySelector('.audio-player');
  const playBtn = card.querySelector('.play-btn');
  const progressBar = card.querySelector('.progress-bar');
  const currentTimeEl = card.querySelector('.current-time');
  const durationEl = card.querySelector('.duration');
  const buyBtn = card.querySelector('.buy-btn');

  // Set duration when metadata loaded
  audio.addEventListener('loadedmetadata', () => {
    durationEl.textContent = formatTime(Math.min(audio.duration || 30, 30));
  });

  // Stop this audio
  const stopAudio = () => {
    if(!audio) return;
    audio.pause();
    audio.currentTime = 0;
    playBtn.textContent = '‚ñ∂';
    progressBar.value = 0;
    currentTimeEl.textContent = '0:00';
    clearTimeout(fragmentTimeout);
    if(expandedAudio === audio) collapsePlayer();
  };

  // Update progress
  const updateProgress = () => {
    if(!audio || audio.paused) return;
    const time = Math.min(audio.currentTime,30);
    progressBar.value = time;
    currentTimeEl.textContent = formatTime(time);
    if(audio.currentTime >= 30){ stopAudio(); return; }
    requestAnimationFrame(updateProgress);
  };

  // Play / Pause button
  playBtn.addEventListener('click', async () => {
    // Pause all other audios (ignore video)
    document.querySelectorAll('audio').forEach(a=>{
      if(a !== audio){
        a.pause();
        a.currentTime = 0;
        const otherCard = a.closest('.card');
        if(otherCard){
          const btn = otherCard.querySelector('.play-btn');
          if(btn) btn.textContent='‚ñ∂';
        }
      }
    });

    if(audio.paused){
      try{ await audio.play(); } catch(e){ console.warn('Playback failed', e); }
      playBtn.textContent = '‚è∏';
      updateProgress();
      fragmentTimeout = setTimeout(()=>{ stopAudio(); }, 30000);
      expandPlayer(card, audio);
    } else stopAudio();
  });

  // Progress bar input
  progressBar.addEventListener('input', ()=>{
    audio.currentTime = parseFloat(progressBar.value);
    currentTimeEl.textContent = formatTime(audio.currentTime);
  });

  // Ended
  audio.addEventListener('ended', stopAudio);

  // Buy button
  if(buyBtn){
    buyBtn.addEventListener('click', async ()=>{
      const filename = buyBtn.dataset.filename;
      buyBtn.disabled = true;
      try{
        const res = await fetch(`/fake-buy/${filename}`, {method:'POST'});
        const data = await res.json();
        if(data.success){
          downloadLink.href = data.download_url;
          modal.style.display = 'flex';
        } else { alert('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã'); }
      } catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
      buyBtn.disabled = false;
    });
  }
});

// ======= EXPANDED PLAYER =======
function expandPlayer(card,audio){
  const thumbImg = card.querySelector('.cover-thumb img');
  playerThumb.src = thumbImg ? thumbImg.src : '';
  playerArtist.textContent = card.querySelector('.artist').textContent;
  playerTitle.textContent = card.querySelector('.filename').textContent;
  playerTime.textContent = `0:00 / 0:30`;
  player.classList.remove('hidden');
  expandedAudio = audio;
  playerPlay.textContent = '‚è∏';
}

function collapsePlayer(){
  player.classList.add('hidden');
  expandedAudio = null;
}

// Play/Pause button on expanded player
playerPlay.addEventListener('click', ()=>{
  if(!expandedAudio) return;
  if(expandedAudio.paused) { expandedAudio.play(); playerPlay.textContent='‚è∏'; }
  else { expandedAudio.pause(); playerPlay.textContent='‚ñ∂'; }
});

// ======= VIDEO SAFETY FOR IOS =======
// Ensure videos can play while audio exists
document.querySelectorAll('video').forEach(video=>{
  video.addEventListener('play', ()=>{
    // Pause all audios except this card (ignore video)
    document.querySelectorAll('audio').forEach(a=>{
      if(!a.paused) a.pause();
      const otherCard = a.closest('.card');
      if(otherCard){
        const btn = otherCard.querySelector('.play-btn');
        if(btn) btn.textContent='‚ñ∂';
      }
    });
  });
});

// ======= POINTER EVENTS FIX ======
// Allow clicks on video even if player overlay exists
player.style.pointerEvents = 'none';
player.querySelectorAll('*').forEach(el=>{
  el.style.pointerEvents = 'auto';
});
</script>

</body>
</html>
