<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ú–µ–¥–∏–∞</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
  .app { display:flex; min-height:100vh; }
  .sidebar { width:220px; background:#222; color:#fff; padding:20px; box-sizing:border-box; }
  .sidebar .logo { font-size:28px; font-weight:bold; margin-bottom:10px; }
  .sidebar h2 { margin:0 0 5px 0; font-size:16px; }
  .sidebar .nav a { display:block; color:#aaa; text-decoration:none; margin:5px 0; }
  .sidebar .nav a.active { color:#0af; font-weight:bold; }
  .main { flex:1; padding:20px; box-sizing:border-box; }
  .card { background:#fff; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
  table th { background:#eee; }
  .danger { background:#e74c3c; color:#fff; border:none; padding:5px 8px; cursor:pointer; }
  .primary { background:#3498db; color:#fff; border:none; padding:5px 12px; cursor:pointer; }
  .drop-area { border:2px dashed #aaa; padding:20px; text-align:center; margin-bottom:10px; border-radius:5px; cursor:pointer; }
  .drop-area.dragover { border-color:#3498db; background:#f0f8ff; }
  input[type=text], input[type=number], select { width:100%; padding:5px; box-sizing:border-box; }
  .search-input { margin-bottom:10px; width:300px; padding:5px; }
</style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="logo">N</div>
    <h2>nesko admin</h2>
    <div style="font-size:12px;color:#aaa;margin-bottom:15px;">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–æ–π –∏ –≤–∏–¥–µ–æ</div>
    <nav class="nav">
      <a class="active" href="#upload" onclick="showTab('upload')">‚ûï –ó–∞–≥—Ä—É–∑–∏—Ç—å</a>
      <a href="#audios" onclick="showTab('audios')">üéµ –ú—É–∑—ã–∫–∞</a>
      <a href="#videos" onclick="showTab('videos')">üé¨ –í–∏–¥–µ–æ</a>
      <a href="#categories" onclick="showTab('categories')">üåç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
      <a href="{{ url_for('logout') }}" style="margin-top:12px; color:#aaa; display:block">–í—ã–π—Ç–∏</a>
    </nav>
  </aside>

  <main class="main">
    <div class="top">
      <div style="font-size:20px;margin-bottom:10px;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ú–µ–¥–∏–∞</div>
      <div style="color:#777;font-size:13px;">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ <strong>{{ ADMIN_USER }}</strong></div>
    </div>

    <!-- UPLOAD -->
    <section id="upload" class="card">
      <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <form action="{{ url_for('admin') }}" method="post" enctype="multipart/form-data" id="upload-form">
        <div class="row">
          <div class="two">
            <label>–¢–∏–ø –º–µ–¥–∏–∞</label>
            <select name="media_type" id="media_type">
              <option value="audio">–ú—É–∑—ã–∫–∞</option>
              <option value="video">–í–∏–¥–µ–æ</option>
            </select>
          </div>

          <div class="two">
            <label>–§–∞–π–ª</label>
            <div class="drop-area" id="drop-area">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ</div>
            <input type="file" name="file" id="file-input" accept="audio/*,video/*" required style="display:none;" />
          </div>
          <div class="two">
  <label>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è</label>
  <input type="text" name="original_name" placeholder="–ò–º—è —Ñ–∞–π–ª–∞" />
</div>

          <div class="two" id="artist_wrap">
            <label>–ê—Ä—Ç–∏—Å—Ç</label>
            <input type="text" name="artist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å" />
          </div>

          <div class="two" id="genre_wrap">
            <label>–ñ–∞–Ω—Ä</label>
            <input type="text" name="genre" placeholder="–ñ–∞–Ω—Ä" />
          </div>

          <div class="two" id="price_wrap">
            <label>–¶–µ–Ω–∞ (‚Ç∫)</label>
            <input type="number" step="0.01" name="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä 3.99" />
          </div>

          <div class="two" id="thumb_wrap">
            <label>–û–±–ª–æ–∂–∫–∞ (jpg/png)</label>
            <input type="file" name="thumb" accept="image/*" />
          </div>

          <div class="two" id="title_wrap" style="display:none">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ</label>
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ" />
          </div>

          <div class="two">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–°—Ç—Ä–∞–Ω–∞)</label>
            <select name="category_id">
              <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="primary" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <div id="upload-status" style="display:none; margin-top:10px; font-weight:600;">
  ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶
</div>

        </div>
      </form>
    </section>

    <!-- AUDIOS -->
    <section id="audios" class="card" style="display:none">
      <h3>üéµ –ú—É–∑—ã–∫–∞</h3>
      <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –∞—É–¥–∏–æ..." oninput="filterTable('audios', this.value)">
      <table>
        <thead>
          <tr><th>–§–∞–π–ª</th><th>–ê—Ä—Ç–∏—Å—Ç</th><th>–ñ–∞–Ω—Ä</th><th>–¶–µ–Ω–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th></th></tr>
        </thead>
            <tbody>
{% for c in covers %}
<tr class="audio-row" data-filename="{{ c.filename }}">
  <td>
    <strong>{{ c.filename }}</strong>
     <small>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è: {{ c.original_name }}</small>
    <br>
    <small><a href="{{ c.url }}" target="_blank">{{ c.url|replace('https://','') }}</a></small>
  </td>

  <!-- –ê—Ä—Ç–∏—Å—Ç -->
  <td>
    <span class="artist">{{ c.artist }}</span>
    <input class="artist-input" type="text" value="{{ c.artist }}" style="display:none">
  </td>

  <!-- –ñ–∞–Ω—Ä -->
  <td>
    <span class="genre">{{ c.genre }}</span>
    <input class="genre-input" type="text" value="{{ c.genre }}" style="display:none">
  </td>

  <!-- –¶–µ–Ω–∞ -->
  <td>
    <span class="price">{{ c.price }}</span>
    <input class="price-input" type="number" value="{{ c.price }}" style="display:none">
  </td>

  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
  <td>
    <span class="category">{{ c.category_name or '‚Äî' }}</span>

    <select class="category-input" style="display:none">
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if cat.name == c.category_name %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>
  </td>

  <!-- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å -->
  <td>
    <button class="save-btn" style="display:none">üíæ</button>

    <form class="delete-media-form" method="post" action="{{ url_for('delete_media', media_type='audio', filename=c.filename) }}">
      <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
    </form>
  </td>
</tr>
{% endfor %}
</tbody>
      </table>
    </section>

   <section id="videos" class="card" style="display:none">
  <h3>üé¨ –í–∏–¥–µ–æ</h3>
  <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." oninput="filterTable('videos', this.value)">
  <table>
    <thead>
      <tr><th>–§–∞–π–ª</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th></th></tr>
    </thead>
    <tbody>
      {% for v in videos %}
      <tr class="video-row" data-filename="{{ v.filename }}">
        <td>{{ v.filename }}<br>
           <small>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è: {{ v.original_name }}</small>
          <small><a href="{{ v.url }}" target="_blank">{{ v.url|replace('https://','') }}</a></small></td>

        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ -->
        <td>
          <span class="title">{{ v.title }}</span>
          <input class="title-input" type="text" value="{{ v.title }}" style="display:none">
        </td>

        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
        <td>
          <span class="category">{{ v.category_name or '‚Äî' }}</span>
          <select class="category-input" style="display:none">
            {% for cat in categories %}
            <option value="{{ cat.id }}" {% if cat.name == v.category_name %}selected{% endif %}>{{ cat.name }}</option>
            {% endfor %}
          </select>
        </td>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <td>
          <button class="save-btn" style="display:none">üíæ</button>
          <button class="danger delete-btn" data-type="video" data-filename="{{ v.filename }}">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>


    <!-- CATEGORIES -->
   <section id="categories" class="card">
  <h3>üåç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–°—Ç—Ä–∞–Ω—ã)</h3>

  <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
 <form id="add-category-form">
   <div id="category-message"></div>
    <input type="text" name="category_name" id="category_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>
  <table>
    <thead>
      <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
    </thead>
    <tbody id="categories-list">
{% for cat in categories %}
<tr data-id="{{ cat.id }}">
  <td>{{ cat.id }}</td>

  <td class="category-cell">
    <span class="cat-name">{{ cat.name }}</span>
    <input class="edit-input" type="text" value="{{ cat.name }}" style="display:none">
    <div class="cat-msg"></div>
  </td>

  <td>
      <form class="delete-category-form" method="post" action="{{ url_for('delete_category') }}">
          <input type="hidden" name="category_id" value="{{ cat.id }}">
          <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
      </form>
  </td>
</tr>
{% endfor %}
</tbody>
  </table>

</section>

  </main>
</div>

<script>
function showTab(id){
  document.querySelectorAll('section.card').forEach(s=> s.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.nav a').forEach(a=> a.classList.remove('active'));
  document.querySelector('.nav a[href="#'+id+'"]').classList.add('active');
}
showTab('upload');

const mediaSelect = document.getElementById('media_type');
const titleWrap = document.getElementById('title_wrap');
const artistWrap = document.getElementById('artist_wrap');
const genreWrap = document.getElementById('genre_wrap');
const priceWrap = document.getElementById('price_wrap');
const thumbWrap = document.getElementById('thumb_wrap');

function updateFields(){
    if(mediaSelect.value==='audio'){
      titleWrap.style.display='none';
      artistWrap.style.display='block';
      genreWrap.style.display='block';
      priceWrap.style.display='block';
      thumbWrap.style.display='block';
    } else {
      titleWrap.style.display='block';
      artistWrap.style.display='none';
      genreWrap.style.display='none';
      priceWrap.style.display='none';
      thumbWrap.style.display='none';
    }
}
mediaSelect.addEventListener('change', updateFields);
updateFields();



// Search filter
function filterTable(sectionId, query){
  query = query.toLowerCase();
  const rows = document.querySelectorAll(`#${sectionId} tbody tr`);
  rows.forEach(r => {
    r.style.display = [...r.cells].some(td => td.innerText.toLowerCase().includes(query)) ? '' : 'none';
  });
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ------------------------------------------------------------------
  // UNIVERSAL AJAX POST
  // ------------------------------------------------------------------
  async function postForm(url, formData) {
    const res = await fetch(url, { method: "POST", body: formData });
    return await res.json();
  }

  // ------------------------------------------------------------------
  // CATEGORY ADD
  // ------------------------------------------------------------------
  const categoryMessage = document.getElementById("category-message");
  const categoriesList = document.getElementById("categories-list");

  const addForm = document.getElementById("add-category-form");
  if (addForm) {
    addForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const data = await postForm("/admin/category/add", new FormData(this));
      categoryMessage.textContent = data.message;

      if (!data.success) return;

      const tr = document.createElement("tr");
      tr.dataset.id = data.category.id;
      tr.innerHTML = `
        <td>${data.category.id}</td>
        <td class="category-cell">
          <span class="cat-name">${data.category.name}</span>
          <input class="edit-input" style="display:none">
          <div class="cat-msg"></div>
        </td>
        <td>
          <form class="delete-category-form" method="post" action="/admin/category/delete">
            <input type="hidden" name="category_id" value="${data.category.id}">
            <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
          </form>
        </td>`;

      categoriesList.appendChild(tr);
      addInlineCategoryEdit(tr);
      tr.querySelector(".delete-category-form").addEventListener("submit", deleteCategoryHandler);
      addForm.reset();
    });
  }

  // ------------------------------------------------------------------
  // CATEGORY DELETE
  // ------------------------------------------------------------------
  async function deleteCategoryHandler(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const tr = form.closest("tr");

    const data = await postForm(form.action, new FormData(form));
    categoryMessage.textContent = data.message;

    if (data.success) tr.remove();
  }

  document.querySelectorAll(".delete-category-form")
    .forEach(f => f.addEventListener("submit", deleteCategoryHandler));

  // ------------------------------------------------------------------
  // MEDIA DELETE (AUDIO / VIDEO)
  // ------------------------------------------------------------------
  async function deleteMediaHandler(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const tr = form.closest("tr");

    const data = await postForm(form.action, new FormData(form));

    if (data.success) tr.remove();
    else alert(data.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞");
  }

  document.querySelectorAll(".delete-media-form")
    .forEach(f => f.addEventListener("submit", deleteMediaHandler));

  // ------------------------------------------------------------------
  // DRAG & DROP UPLOAD UI
  // ------------------------------------------------------------------
  const dropArea = document.getElementById("drop-area");
  const fileInput = document.getElementById("file-input");

  if (dropArea && fileInput) {
    const showFileName = (file) => dropArea.textContent = file.name;

    dropArea.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length) showFileName(fileInput.files[0]);
    });

    dropArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropArea.classList.add("dragover");
    });

    dropArea.addEventListener("dragleave", () => dropArea.classList.remove("dragover"));

    dropArea.addEventListener("drop", (e) => {
      e.preventDefault();
      dropArea.classList.remove("dragover");
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        showFileName(e.dataTransfer.files[0]);
      }
    });
  }

  // ------------------------------------------------------------------
  // INLINE CATEGORY EDIT
  // ------------------------------------------------------------------
  function addInlineCategoryEdit(row) {
    const cell = row.querySelector(".category-cell");
    if (!cell) return;

    const nameSpan = cell.querySelector(".cat-name");
    const input = cell.querySelector(".edit-input");
    const msg = cell.querySelector(".cat-msg");
    const id = row.dataset.id;

    let editing = false;

    cell.ondblclick = () => {
      if (editing) return;
      editing = true;
      input.value = nameSpan.textContent;
      nameSpan.style.display = "none";
      input.style.display = "inline-block";
      input.focus();
      input.select();
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") save();
      if (e.key === "Escape") cancel();
    });

    input.addEventListener("blur", save);

    async function save() {
      if (!editing) return;
      editing = false;

      const newName = input.value.trim();
      if (!newName) {
        msg.textContent = "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!";
        return cancel();
      }

      const fd = new FormData();
      fd.append("category_id", id);
      fd.append("category_name", newName);

      const data = await postForm("/admin/category/update", fd);
      msg.textContent = data.message;
      if (data.success) nameSpan.textContent = newName;

      nameSpan.style.display = "inline-block";
      input.style.display = "none";
    }

    function cancel() {
      editing = false;
      nameSpan.style.display = "inline-block";
      input.style.display = "none";
    }
  }

  document.querySelectorAll("#categories-list tr").forEach(addInlineCategoryEdit);

  // ------------------------------------------------------------------
  // INLINE MEDIA EDIT (AUDIO / VIDEO)
  // ------------------------------------------------------------------
  function addInlineMediaEdit(row, fields, mediaType = "audio") {
    const saveBtn = row.querySelector(".save-btn");
    const editing = {};

    fields.forEach(field => {
      const span = row.querySelector(`.${field}`);
      const input = row.querySelector(`.${field}-input`);
      if (!span || !input) return;

      span.addEventListener("dblclick", () => {
        span.style.display = "none";
        input.style.display = "inline-block";
        input.focus();
        if (input.select) input.select();
        editing[field] = true;
        if (saveBtn) saveBtn.style.display = "inline-block";
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") save();
        if (e.key === "Escape") cancel();
      });

      input.addEventListener("blur", () => editing[field] && save());
    });

    async function save() {
      const fd = new FormData();
      fd.append("media_type", mediaType);
      fd.append("filename", row.dataset.filename);

      fields.forEach(field => {
        const input = row.querySelector(`.${field}-input`);
        if (field === "category") {
          fd.append("category_id", input.value);
        } else {
          fd.append(field, input.value);
        }
      });

      const data = await postForm("/admin/media/update", fd);
      alert(data.message || "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");

      if (data.success) {
        fields.forEach(field => {
          const span = row.querySelector(`.${field}`);
          const input = row.querySelector(`.${field}-input`);
          if (field === "category") {
            span.textContent = input.options[input.selectedIndex].text;
          } else {
            span.textContent = input.value;
          }
        });
      }

      cancel();
    }

    function cancel() {
      fields.forEach(field => {
        const span = row.querySelector(`.${field}`);
        const input = row.querySelector(`.${field}-input`);
        span.style.display = "inline";
        input.style.display = "none";
        editing[field] = false;
      });
      if (saveBtn) saveBtn.style.display = "none";
    }
  }

  document.querySelectorAll(".audio-row")
    .forEach(row => addInlineMediaEdit(row, ["artist", "genre", "price", "category"], "audio"));

});
</script>

<script>
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("delete-btn")) return;

  const btn = e.target;
  const mediaType = btn.dataset.type;
  const filename = btn.dataset.filename;

  if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${filename}?`)) return;

  const res = await fetch(`/admin/delete/${mediaType}/${filename}`, {
    method: "POST"
  });

  const data = await res.json();

  if (data.success) {
    // —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    btn.closest("tr").remove();
  } else {
    alert("–û—à–∏–±–∫–∞: " + data.message);
  }
});
</script>
<script>
document.getElementById("file-input").addEventListener("change", validateFile);
document.getElementById("drop-area").addEventListener("drop", validateFileDrop);

function validateFile(event) {
    const mediaType = document.getElementById("media_type").value;
    const file = event.target.files[0];
    if (!file) return;

    if (!checkCorrect(mediaType, file)) {
        event.target.value = ""; // —Å–±—Ä–æ—Å–∏—Ç—å input
    }
}

function validateFileDrop(event) {
    event.preventDefault();
    const mediaType = document.getElementById("media_type").value;
    const file = event.dataTransfer.files[0];
    if (!file) return;

    if (!checkCorrect(mediaType, file)) return;

    // –µ—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –∫–ª–∞–¥—ë–º –≤ input
    document.getElementById("file-input").files = event.dataTransfer.files;
    document.getElementById("drop-area").textContent = file.name;
}

function checkCorrect(mediaType, file) {
    const isAudio = file.type.startsWith("audio");
    const isVideo = file.type.startsWith("video");

    if (mediaType === "audio" && isVideo) {
        alert("‚ùå –í—ã –≤—ã–±—Ä–∞–ª–∏ '–ú—É–∑—ã–∫–∞', –Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –≤–∏–¥–µ–æ-—Ñ–∞–π–ª!");
        return false;
    }
    if (mediaType === "video" && isAudio) {
        alert("‚ùå –í—ã –≤—ã–±—Ä–∞–ª–∏ '–í–∏–¥–µ–æ', –Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∞—É–¥–∏–æ-—Ñ–∞–π–ª!");
        return false;
    }
    return true;
}
</script>

<script>
document.getElementById("upload-form").addEventListener("submit", function (e) {
    e.preventDefault(); // –æ—Ç–º–µ–Ω—è–µ–º –æ–±—ã—á–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É

    const form = this;
    const btn = form.querySelector("button[type='submit']");
    const status = document.getElementById("upload-status");
    const fileInput = document.getElementById("file-input");
    const mediaType = document.getElementById("media_type").value;

    if (!fileInput.files.length) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
        return;
    }

    const file = fileInput.files[0];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    if (mediaType === "audio" && !file.type.startsWith("audio/")) {
        alert("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∞—É–¥–∏–æ.");
        return;
    }
    if (mediaType === "video" && !file.type.startsWith("video/")) {
        alert("–û—à–∏–±–∫–∞! –í—ã–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤–∏–¥–µ–æ.");
        return;
    }

    const formData = new FormData(form);
    const xhr = new XMLHttpRequest();

    xhr.open("POST", form.action);

    btn.disabled = true;
    status.style.display = "block";

    xhr.upload.addEventListener("progress", e => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            status.textContent = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶ ${percent}%`;
        }
    });

    xhr.onload = () => {
        btn.disabled = false;
        if (xhr.status === 200) {
            status.textContent = "‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ!";
            form.reset();
            setTimeout(() => { status.style.display = "none"; }, 2000);
        } else {
            status.textContent = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!";
        }
    };

    xhr.onerror = () => {
        btn.disabled = false;
        status.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞.";
    };

    xhr.send(formData);
});
</script>



<script>
function addInlineMediaEdit(row, fields, mediaType = "video") {
  const saveBtn = row.querySelector(".save-btn");
  const editing = {};

  fields.forEach(field => {
    const span = row.querySelector(`.${field}`);
    const input = row.querySelector(`.${field}-input`);
    if (!span || !input) return;

    span.addEventListener("dblclick", () => {
      span.style.display = "none";
      input.style.display = "inline-block";
      input.focus();
      if (input.select) input.select();
      editing[field] = true;
      if (saveBtn) saveBtn.style.display = "inline-block";
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") save();
      if (e.key === "Escape") cancel();
    });

    input.addEventListener("blur", () => editing[field] && save());
  });

  async function save() {
    const fd = new FormData();
    fd.append("media_type", mediaType);
    fd.append("filename", row.dataset.filename);

    fields.forEach(field => {
      const input = row.querySelector(`.${field}-input`);
      if (field === "category") {
        fd.append("category_id", input.value);
      } else {
        fd.append(field, input.value);
      }
    });

    const res = await fetch("/admin/media/update", {
      method: "POST",
      body: fd
    });
    const data = await res.json();
    alert(data.message || "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");

    if (data.success) {
      fields.forEach(field => {
        const span = row.querySelector(`.${field}`);
        const input = row.querySelector(`.${field}-input`);
        if (field === "category") {
          span.textContent = input.options[input.selectedIndex].text;
        } else {
          span.textContent = input.value;
        }
      });
    }

    cancel();
  }

  function cancel() {
    fields.forEach(field => {
      const span = row.querySelector(`.${field}`);
      const input = row.querySelector(`.${field}-input`);
      span.style.display = "inline";
      input.style.display = "none";
      editing[field] = false;
    });
    if (saveBtn) saveBtn.style.display = "none";
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ
document.querySelectorAll(".video-row")
  .forEach(row => addInlineMediaEdit(row, ["title", "category"], "video"));
</script>



</body>
</html>
