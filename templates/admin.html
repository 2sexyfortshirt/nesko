<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ú–µ–¥–∏–∞</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
  .app { display:flex; min-height:100vh; }
  .sidebar { width:220px; background:#222; color:#fff; padding:20px; box-sizing:border-box; }
  .sidebar .logo { font-size:28px; font-weight:bold; margin-bottom:10px; }
  .sidebar h2 { margin:0 0 5px 0; font-size:16px; }
  .sidebar .nav a { display:block; color:#aaa; text-decoration:none; margin:5px 0; }
  .sidebar .nav a.active { color:#0af; font-weight:bold; }
  .main { flex:1; padding:20px; box-sizing:border-box; }
  .card { background:#fff; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
  table th { background:#eee; }
  .danger { background:#e74c3c; color:#fff; border:none; padding:5px 8px; cursor:pointer; }
  .primary { background:#3498db; color:#fff; border:none; padding:5px 12px; cursor:pointer; }
  .drop-area { border:2px dashed #aaa; padding:20px; text-align:center; margin-bottom:10px; border-radius:5px; cursor:pointer; }
  .drop-area.dragover { border-color:#3498db; background:#f0f8ff; }
  input[type=text], input[type=number], select { width:100%; padding:5px; box-sizing:border-box; }
  .search-input { margin-bottom:10px; width:300px; padding:5px; }
</style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="logo">N</div>
    <h2>nesko admin</h2>
    <div style="font-size:12px;color:#aaa;margin-bottom:15px;">—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–æ–π –∏ –≤–∏–¥–µ–æ</div>
    <nav class="nav">
      <a class="active" href="#upload" onclick="showTab('upload')">‚ûï –ó–∞–≥—Ä—É–∑–∏—Ç—å</a>
      <a href="#audios" onclick="showTab('audios')">üéµ –ú—É–∑—ã–∫–∞</a>
      <a href="#videos" onclick="showTab('videos')">üé¨ –í–∏–¥–µ–æ</a>
      <a href="#categories" onclick="showTab('categories')">üåç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
      <a href="{{ url_for('logout') }}" style="margin-top:12px; color:#aaa; display:block">–í—ã–π—Ç–∏</a>
    </nav>
  </aside>

  <main class="main">
    <div class="top">
      <div style="font-size:20px;margin-bottom:10px;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî –ú–µ–¥–∏–∞</div>
      <div style="color:#777;font-size:13px;">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ <strong>{{ ADMIN_USER }}</strong></div>
    </div>

    <!-- UPLOAD -->
    <section id="upload" class="card">
      <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</h3>
      <form action="{{ url_for('admin') }}" method="post" enctype="multipart/form-data" id="upload-form">
        <div class="row">
          <div class="two">
            <label>–¢–∏–ø –º–µ–¥–∏–∞</label>
            <select name="media_type" id="media_type">
              <option value="audio">–ú—É–∑—ã–∫–∞</option>
              <option value="video">–í–∏–¥–µ–æ</option>
            </select>
          </div>

          <div class="two">
            <label>–§–∞–π–ª</label>
            <div class="drop-area" id="drop-area">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ</div>
            <input type="file" name="file" id="file-input" accept="audio/*,video/*" required style="display:none;" />
          </div>

          <div class="two" id="artist_wrap">
            <label>–ê—Ä—Ç–∏—Å—Ç</label>
            <input type="text" name="artist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å" />
          </div>

          <div class="two" id="genre_wrap">
            <label>–ñ–∞–Ω—Ä</label>
            <input type="text" name="genre" placeholder="–ñ–∞–Ω—Ä" />
          </div>

          <div class="two" id="price_wrap">
            <label>–¶–µ–Ω–∞ (‚Ç∫)</label>
            <input type="number" step="0.01" name="price" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä 3.99" />
          </div>

          <div class="two" id="thumb_wrap">
            <label>–û–±–ª–æ–∂–∫–∞ (jpg/png)</label>
            <input type="file" name="thumb" accept="image/*" />
          </div>

          <div class="two" id="title_wrap" style="display:none">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ</label>
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ" />
          </div>

          <div class="two">
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–°—Ç—Ä–∞–Ω–∞)</label>
            <select name="category_id">
              <option value="">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="primary" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </form>
    </section>

    <!-- AUDIOS -->
    <section id="audios" class="card" style="display:none">
      <h3>üéµ –ú—É–∑—ã–∫–∞</h3>
      <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –∞—É–¥–∏–æ..." oninput="filterTable('audios', this.value)">
      <table>
        <thead>
          <tr><th>–§–∞–π–ª</th><th>–ê—Ä—Ç–∏—Å—Ç</th><th>–ñ–∞–Ω—Ä</th><th>–¶–µ–Ω–∞</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th></th></tr>
        </thead>
            <tbody>
          {% for c in covers %}
      <tr data-filename="{{ c.filename }}">
      <td>{{ c.filename }}<br><small><a href="{{ c.url }}" target="_blank">{{ c.url|replace('https://','') }}</a></small></td>
      <td>{{ c.artist }}</td>
      <td>{{ c.genre }}</td>
      <td>{{ c.price }} ‚Ç∫</td>
      <td>{{ c.category_name or '‚Äî' }}</td>
      <td>
        <form class="delete-media-form" method="post" action="{{ url_for('delete_media', media_type='audio', filename=c.filename) }}">
          <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
        </form>
      </td>
    </tr>
    {% endfor %}
</tbody>
      </table>
    </section>

    <!-- VIDEOS -->
    <section id="videos" class="card" style="display:none">
      <h3>üé¨ –í–∏–¥–µ–æ</h3>
      <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ..." oninput="filterTable('videos', this.value)">
      <table>
        <thead>
          <tr><th>–§–∞–π–ª</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th></th></tr>
        </thead>
        <tbody>
        {% for v in videos %}
          <tr>
            <td>{{ v.filename }}<br><small><a href="{{ v.url }}" target="_blank">{{ v.url|replace('https://','') }}</a></small></td>
            <td>{{ v.title }}</td>
            <td>{{ v.category_name or '‚Äî' }}</td>
            <td>
              <form action="{{ url_for('delete_media', media_type='video', filename=v.filename) }}" method="post">
                <button class="danger">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr><td colspan="4" style="color:#777">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- CATEGORIES -->
   <section id="categories" class="card">
  <h3>üåç –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–°—Ç—Ä–∞–Ω—ã)</h3>

  <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
 <form id="add-category-form">
   <div id="category-message"></div>
    <input type="text" name="category_name" id="category_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>
  <table>
    <thead>
      <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
    </thead>
    <tbody>
      <tbody id="categories-list">
      {% for cat in categories %}
      <tr>
        <td>{{ cat.id }}</td>
        <td>{{ cat.name }}</td>
        <td>
           <form class="delete-category-form" method="post" action="{{ url_for('delete_category') }}">
                <input type="hidden" name="category_id" value="{{ cat.id }}">
                <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          <div id="category-messages"></div>

        </td>
      </tr>
      {% else %}
      <tr><td colspan="3" style="color:#777">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</td></tr>
      {% endfor %}

    </tbody>
  </table>

</section>

  </main>
</div>

<script>
function showTab(id){
  document.querySelectorAll('section.card').forEach(s=> s.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.nav a').forEach(a=> a.classList.remove('active'));
  document.querySelector('.nav a[href="#'+id+'"]').classList.add('active');
}
showTab('upload');

const mediaSelect = document.getElementById('media_type');
const titleWrap = document.getElementById('title_wrap');
const artistWrap = document.getElementById('artist_wrap');
const genreWrap = document.getElementById('genre_wrap');
const priceWrap = document.getElementById('price_wrap');
const thumbWrap = document.getElementById('thumb_wrap');

function updateFields(){
    if(mediaSelect.value==='audio'){
      titleWrap.style.display='none';
      artistWrap.style.display='block';
      genreWrap.style.display='block';
      priceWrap.style.display='block';
      thumbWrap.style.display='block';
    } else {
      titleWrap.style.display='block';
      artistWrap.style.display='none';
      genreWrap.style.display='none';
      priceWrap.style.display='none';
      thumbWrap.style.display='none';
    }
}
mediaSelect.addEventListener('change', updateFields);
updateFields();



// Search filter
function filterTable(sectionId, query){
  query = query.toLowerCase();
  const rows = document.querySelectorAll(`#${sectionId} tbody tr`);
  rows.forEach(r => {
    r.style.display = [...r.cells].some(td => td.innerText.toLowerCase().includes(query)) ? '' : 'none';
  });
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

  const categoryMessage = document.getElementById("category-message");
  const categoriesList = document.getElementById("categories-list");

  // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ AJAX ---
  const addForm = document.getElementById("add-category-form");
  addForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("/admin/category/add", {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      categoryMessage.textContent = data.message;
      if (data.success) {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
        const tr = document.createElement("tr");
        tr.setAttribute("data-id", data.category.id);
        tr.innerHTML = `
          <td>${data.category.id}</td>
          <td>${data.category.name}</td>
          <td>
            <form class="delete-category-form" method="post" action="/admin/category/delete">
              <input type="hidden" name="category_id" value="${data.category.id}">
              <button type="submit" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </td>
        `;
        categoriesList.appendChild(tr);

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.getElementById("category_name").value = "";

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        tr.querySelector(".delete-category-form").addEventListener("submit", deleteCategoryHandler);
      }
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err));
  });

  // --- –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ AJAX ---
  function deleteCategoryHandler(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const formData = new FormData(form);
    const tr = form.closest("tr");

    fetch(form.action, {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      categoryMessage.textContent = data.message;
      if (data.success && tr) tr.remove();
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err));
  }

  document.querySelectorAll(".delete-category-form").forEach(form => {
    form.addEventListener("submit", deleteCategoryHandler);
  });

  // --- –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞ (audio/video) —á–µ—Ä–µ–∑ AJAX ---
  function deleteMediaHandler(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const formData = new FormData(form);
    const tr = form.closest("tr");

    fetch(form.action, {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success && tr) tr.remove();
      else alert(data.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞");
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–¥–∏–∞:", err));
  }

  document.querySelectorAll("#audios .danger, #videos .danger").forEach(button => {
    const form = button.closest("form");
    form.addEventListener("submit", deleteMediaHandler);
  });

});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

  function deleteMediaHandler(e) {
    e.preventDefault();
    const form = e.currentTarget;
    const tr = form.closest("tr");
    const formData = new FormData(form);

    fetch(form.action, {
      method: "POST",
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success && tr) {
        tr.remove(); // —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã
      } else {
        alert(data.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞");
      }
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ AJAX:", err));
  }

  document.querySelectorAll(".delete-media-form").forEach(form => {
    form.addEventListener("submit", deleteMediaHandler);
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const dropArea = document.getElementById("drop-area");
  const fileInput = document.getElementById("file-input");

  // –ö–ª–∏–∫ –ø–æ drop-area ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  dropArea.addEventListener("click", () => fileInput.click());

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
  function showFileName(file) {
    dropArea.textContent = file.name;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–µ—Ä–µ–∑ input
  fileInput.addEventListener("change", function() {
    if (this.files.length > 0) {
      showFileName(this.files[0]);
    }
  });

  // Drag & drop
  dropArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropArea.style.border = "2px dashed #4CAF50"; // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
  });

  dropArea.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropArea.style.border = "2px dashed #ccc";
  });

  dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    dropArea.style.border = "2px dashed #ccc";

    if (e.dataTransfer.files.length > 0) {
      fileInput.files = e.dataTransfer.files; // –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ input
      showFileName(e.dataTransfer.files[0]);
    }
  });
});
</script>





</body>
</html>
